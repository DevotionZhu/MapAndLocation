# 周报

## 6.18

本周在研究地图，主要做了以下工作

**1、详细研究了阿波罗地图的在系统中的流转形式，如何使用，如何采集轨迹，以及应对哪些场景**

​       并阅读了相关源码。

高精地图是以opendrive的格式存在xml文件中，它有base_map（完整）, routing_map（道路拓扑图）**和**sim_map（最减版，用于可视化）三种级别。不管原始数据格式为什么，在Apollo内部的数据地图的格式为proto格式。

HDMAP引擎是Apollo里面用于从HDMAP里面提取相关元素给下游的一个模块。结合源码来看，hdmap完成两个工作，

它有一个opendrive adpter，主要是读取xml格式的原始地图，完成地图数据解析，并重新组织，封装成提前定义好的proto格式的map。

第二个是为下游提供加载高精地图的数据接口，可以通过ID或者空间位置去检索高精地图的所有元素，比如**给定一个点和半径，可以把这个范围之内所有的红绿灯都提出来**。











有了原始从xml格式到protobuf的数据之后，就可以访问这些高精地图的元素，Apollo高精地图提供如下的方法获取元素。提供高精地图元素获取的方法实现类：



​	主要是由方法opendrive_adapter.cc中的以下方法解析并读modules/map/hd_map/opendrive_adapter.cc

解析的过程主要分为以下四个过程：根目录、header、道路、路口等节点，解析成Proto格式地图，就可以用apollo::hdmap::HDMapImpl的方法来获取元素id，就可以为Apollo中的多个模块，或者统一的方法所使用。

​	高精地图主要嵌套定义了以下对象Map， 边界形状，道路边缘等元素，车道，路口等

   apollo引入相对地图，过人工驾驶方式录制测试道路上的行驶轨迹，平滑处理，生成相对地图的导航线，存放在云端。

在有GPS信号的情况下可确定其绝对坐标，

请求云端导航地图，获取道路级别的routing,与之前生成的导航线相匹配，作为车道中心线，车道线作为左右边界，产生相对地图。

应对场景

仅依靠视觉感知的车道标识（纯摄像头）+车道线

##### 相对地图模式2，依靠视觉感知与云端导航线（摄像头+GPS）

##### 相对地图模式3，依靠视觉感知、云端导航线以及高精地图(摄像头+GPS+高精地图)



录制包含location,gps,can bus的bag包用/tools/navigatorpython extractor.py提取裸数据，smooth.sh进行平滑处理，编译Dreamview前端，打开导航模式，发送参考线..



2、**研究了下slam建图loam的论文及代码实现**，LOAM源码主要由四个节点构成，分别完成特征点提取，高频低精度odom， 低频高精度odom， 双频odom融合的功能，

ScanRegistration针对单个scan提取两种特征点（corner和surface）,形成特征点云

laserOdometry实现运动补偿和帧间配准，得到一个精度较差的ODOM。（高频率，低精度）,帧与帧配准的初始POSE可以由IMU得到，或者在没有IMU的时候由匀速运动模型

laserMapping实现了一个较为完整的SLAM过程,也就是同时建图和定位，建立了两种特征点云地图，将新入的帧与地图作配准,得到更精准的POSE，更新地图。

在[transformMaintenance](https://link.zhihu.com/?target=https%3A//github.com/daobilige-su/loam_velodyne/blob/master/src/transformMaintenance.cpp%22%20%5Co%20%22transformMaintenance.cpp)中为[laserMapping](https://link.zhihu.com/?target=https%3A//github.com/daobilige-su/loam_velodyne/blob/master/src/laserMapping.cpp%22%20%5Co%20%22laserMapping.cpp)输出的低频ODOM提供插值,以获得高频高精度(10HZ)的ODOM.

当然这个地图功能还不够完善，比如没有回环检测，这时候可以参考LeGO-LOAM



3.真车调试

车道线检测卡住了，代码环境需要调整，协助华班配好了小车的apollo

